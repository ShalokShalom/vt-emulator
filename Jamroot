include jam/cxxflags.jam ;

constant SRC : src ;
constant SRC_TEST : test ;
constant RVT_SRC : $(SRC)/rvt ;
constant RVT_LIB_SRC : $(SRC)/rvt_lib ;
constant RVT_TEST : $(SRC_TEST)/rvt ;
constant RVT_LIB_TEST : $(SRC_TEST)/rvt_lib ;

project vt_emulator
: requirements
    <include>src
    <include>redemption/src
    <include>redemption/src/system/linux

    <cxxflags>-std=c++11

    $(CXXFLAGS)

   : default-build release
;


import os ;

rule setvar ( env : default * )
{
    if [ os.environ $(env) ]
    {
        return [ os.environ $(env) ] ;
    }
    else
    {
        return $(default) ;
    }
}

constant LIB_PREFIX : [ setvar LIB_PREFIX : build/lib ] ;
constant INCLUDE_PREFIX : [ setvar INCLUDE_PREFIX : build/include/wallix/vt-emulator ] ;
constant TTY_BROWSER_JS_FILE : [ setvar TTY_BROWSER_JS_PREFIX : build/browser ] ;
constant TTY_BROWSER_CSS_FILE : [ setvar TTY_BROWSER_CSS_PREFIX : build/browser ] ;

explicit install install-libs install-headers install-tty-browser install-tty-browser-css install-tty-browser-js ;
alias install-tty-browser : install-tty-browser-css install-tty-browser-js ;
alias install : install-libs install-headers ;

alias libs : libwallix_term ;

install install-libs
    : libs
    :
    : <install-type>LIB <location>$(LIB_PREFIX)
    ;

install install-headers
    : [ glob $(RVT_LIB_SRC)/*.hpp ]
    :
    : <location>$(INCLUDE_PREFIX)
    ;

install install-tty-browser-js
    : browser/tty-emulator/html_rendering.js
    :
    : <location>$(TTY_BROWSER_JS_FILE)
    ;

install install-tty-browser-css
    : browser/tty-emulator/player.css
    :
    : <location>$(TTY_BROWSER_CSS_FILE)
    ;


lib libboost_unit_test : : <name>boost_unit_test_framework <link>shared ;

constant TEST_DEPENDENCIES :
    <cxxflags>-frtti
    <library>libboost_unit_test
;

import testing ;

obj screen : $(RVT_SRC)/screen.cpp ;
obj emulator : $(RVT_SRC)/vt_emulator.cpp ;
obj text_rendering : $(RVT_SRC)/text_rendering.cpp ;

alias libemu : emulator screen ;

lib libwallix_term : text_rendering libemu $(RVT_LIB_SRC)/terminal_emulator.cpp : <cxxflags>-fPIC ;
alias libterm : libwallix_term ;

## Tools
## @{
exe terminal_browser : tools/terminal_browser.cpp libterm : ;
## @}


## Tests
## @{
unit-test test_character_color : $(RVT_TEST)/test_character_color.cpp : $(TEST_DEPENDENCIES) ;
unit-test test_character : $(RVT_TEST)/test_character.cpp : $(TEST_DEPENDENCIES) ;
unit-test test_charsets : $(RVT_TEST)/test_charsets.cpp : $(TEST_DEPENDENCIES) ;

unit-test test_screen : $(RVT_TEST)/test_screen.cpp screen : $(TEST_DEPENDENCIES) ;

unit-test test_utf8_decoder : $(RVT_TEST)/test_utf8_decoder.cpp : $(TEST_DEPENDENCIES) ;

unit-test test_vt_emulator : $(RVT_TEST)/test_vt_emulator.cpp libemu : $(TEST_DEPENDENCIES) ;

unit-test test_terminal_emulator : $(RVT_LIB_TEST)/test_terminal_emulator.cpp libterm : $(TEST_DEPENDENCIES) ;
## }
